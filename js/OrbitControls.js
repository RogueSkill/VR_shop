/**
 * @author qiao / https://github.com/qiao
 * @author mrdoob / http://mrdoob.com
 * @author alteredq / http://alteredqualia.com/
 * @author WestLangley / http://github.com/WestLangley
 * @author erich666 / http://erichaines.com
 */
/*global THREE, console */

// This set of controls performs orbiting, dollying (zooming), and panning. It maintains
// the "up" direction as +Y, unlike the TrackballControls. Touch on tablet and phones is
// supported.
FEIKI.OrbitControls=function(A,B){function C(b){if(!1!==a.enabled){b.preventDefault();var c=a.domElement===document?a.domElement.body:a.domElement;if(e===d.ROTATE){if(!0===a.noRotate)return;g.set(b.clientX,b.clientY);h.subVectors(g,k);a.rotateLeft(2*Math.PI*h.x/c.clientWidth*a.rotateSpeed);a.rotateUp(2*Math.PI*h.y/c.clientHeight*a.rotateSpeed);k.copy(g)}else if(e===d.DOLLY){if(!0===a.noZoom)return;l.set(b.clientX,b.clientY);u.subVectors(l,m);0<u.y?a.dollyIn():a.dollyOut();m.copy(l)}else if(e===d.PAN){if(!0===a.noPan)return;n.set(b.clientX,b.clientY);p.subVectors(n,q);a.pan(p.x,p.y);q.copy(n)}a.update()}}function D(){!1!==a.enabled&&(document.removeEventListener("mousemove",C,!1),document.removeEventListener("mouseup",D,!1),a.dispatchEvent(y),e=d.NONE)}function E(b){if(!1!==a.enabled&&!0!==a.noZoom){"CANVAS"==b.target.nodeName&&b.preventDefault();var c=0;void 0!==b.wheelDelta?c=b.wheelDelta:void 0!==b.detail&&(c=-b.detail);0<c?a.dollyOut():a.dollyIn();a.update();a.dispatchEvent(z);a.dispatchEvent(y)}}this.object=A;this.domElement=void 0!==B?B:document;this.enabled=!0;this.center=this.target=new FEIKI.Vector3;this.noZoom=!1;this.zoomSpeed=1;this.minDistance=0;this.maxDistance=Infinity;this.noRotate=!1;this.rotateSpeed=1;this.noPan=!1;this.keyPanSpeed=7;this.autoRotate=!0;this.autoRotateSpeed=3;this.minPolarAngle=0;this.maxPolarAngle=Math.PI;this.noKeys=!1;this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var a=this,k=new FEIKI.Vector2,g=new FEIKI.Vector2,h=new FEIKI.Vector2,q=new FEIKI.Vector2,n=new FEIKI.Vector2,p=new FEIKI.Vector2,r=new FEIKI.Vector3,f=new FEIKI.Vector3,m=new FEIKI.Vector2,l=new FEIKI.Vector2,u=new FEIKI.Vector2,v=0,w=0,t=1,x=new FEIKI.Vector3,F=new FEIKI.Vector3,G=new FEIKI.Quaternion,d={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},e=d.NONE;this.target0=this.target.clone();this.position0=this.object.position.clone();var H=(new FEIKI.Quaternion).setFromUnitVectors(A.up,new FEIKI.Vector3(0,1,0)),I=H.clone().inverse(),J={type:"change"},z={type:"start"},y={type:"end"};this.rotateLeft=function(b){void 0===b&&(b=2*Math.PI/60/60*a.autoRotateSpeed);w-=b};this.rotateUp=function(b){void 0===b&&(b=2*Math.PI/60/60*a.autoRotateSpeed);v-=b};this.panLeft=function(a){var c=this.object.matrix.elements;r.set(c[0],c[1],c[2]);r.multiplyScalar(-a);x.add(r)};this.panUp=function(a){var c=this.object.matrix.elements;r.set(c[4],c[5],c[6]);r.multiplyScalar(a);x.add(r)};this.pan=function(b,c){var d=a.domElement===document?a.domElement.body:a.domElement;if(void 0!==a.object.fov){var e=a.object.position.clone().sub(a.target).length(),e=e*Math.tan(a.object.fov/2*Math.PI/180);a.panLeft(2*b*e/d.clientHeight);a.panUp(2*c*e/d.clientHeight)}else void 0!==a.object.top?(a.panLeft(b*(a.object.right-a.object.left)/d.clientWidth),a.panUp(c*(a.object.top-a.object.bottom)/d.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")};this.dollyIn=function(b){void 0===b&&(b=Math.pow(.95,a.zoomSpeed));t/=b};this.dollyOut=function(b){void 0===b&&(b=Math.pow(.95,a.zoomSpeed));t*=b};this.update=function(){var b=this.object.position;f.copy(b).sub(this.target);f.applyQuaternion(H);var c=Math.atan2(f.x,f.z),d=Math.atan2(Math.sqrt(f.x*f.x+f.z*f.z),f.y);this.autoRotate&&this.rotateLeft(2*Math.PI/60/60*a.autoRotateSpeed);var c=c+w,d=d+v,d=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,d)),d=Math.max(1E-6,Math.min(Math.PI-1E-6,d)),e=f.length()*t,e=Math.max(this.minDistance,Math.min(this.maxDistance,e));this.target.add(x);f.x=e*Math.sin(d)*Math.sin(c);f.y=e*Math.cos(d);f.z=e*Math.sin(d)*Math.cos(c);f.applyQuaternion(I);b.copy(this.target).add(f);this.object.lookAt(this.target);v=w=0;t=1;x.set(0,0,0);if(1E-6<F.distanceToSquared(this.object.position)||1E-6<8*(1-G.dot(this.object.quaternion)))this.dispatchEvent(J),F.copy(this.object.position),G.copy(this.object.quaternion)};this.reset=function(){e=d.NONE;this.target.copy(this.target0);this.object.position.copy(this.position0);this.update()};this.domElement.addEventListener("contextmenu",function(a){a.preventDefault()},!1);this.domElement.addEventListener("mousedown",function(b){if(!1!==a.enabled){b.preventDefault();if(0===b.button){if(!0===a.noRotate)return;e=d.ROTATE;k.set(b.clientX,b.clientY)}else if(1===b.button){if(!0===a.noZoom)return;e=d.DOLLY;m.set(b.clientX,b.clientY)}else if(2===b.button){if(!0===a.noPan)return;e=d.PAN;q.set(b.clientX,b.clientY)}document.addEventListener("mousemove",C,!1);document.addEventListener("mouseup",D,!1);a.dispatchEvent(z)}},!1);this.domElement.addEventListener("mousewheel",E,!1);this.domElement.addEventListener("DOMMouseScroll",E,!1);this.domElement.addEventListener("touchstart",function(b){if(!1!==a.enabled){switch(b.touches.length){case 1:if(!0===a.noRotate)return;e=d.TOUCH_ROTATE;k.set(b.touches[0].pageX,b.touches[0].pageY);break;case 2:if(!0===a.noZoom)return;e=d.TOUCH_DOLLY;var c=b.touches[0].pageX-b.touches[1].pageX;b=b.touches[0].pageY-b.touches[1].pageY;c=Math.sqrt(c*c+b*b);m.set(0,c);break;case 3:if(!0===a.noPan)return;e=d.TOUCH_PAN;q.set(b.touches[0].pageX,b.touches[0].pageY);break;default:e=d.NONE}a.dispatchEvent(z)}},!1);this.domElement.addEventListener("touchend",function(){!1!==a.enabled&&(a.dispatchEvent(y),e=d.NONE)},!1);this.domElement.addEventListener("touchmove",function(b){if(!1!==a.enabled){b.preventDefault();b.stopPropagation();var c=a.domElement===document?a.domElement.body:a.domElement;switch(b.touches.length){case 1:if(!0===a.noRotate)break;if(e!==d.TOUCH_ROTATE)break;g.set(b.touches[0].pageX,b.touches[0].pageY);h.subVectors(g,k);a.rotateLeft(2*Math.PI*h.x/c.clientWidth*a.rotateSpeed);a.rotateUp(2*Math.PI*h.y/c.clientHeight*a.rotateSpeed);k.copy(g);a.update();break;case 2:if(!0===a.noZoom)break;if(e!==d.TOUCH_DOLLY)break;c=b.touches[0].pageX-b.touches[1].pageX;b=b.touches[0].pageY-b.touches[1].pageY;b=Math.sqrt(c*c+b*b);l.set(0,b);u.subVectors(l,m);0<u.y?a.dollyOut():a.dollyIn();m.copy(l);a.update();break;case 3:if(!0===a.noPan)break;if(e!==d.TOUCH_PAN)break;n.set(b.touches[0].pageX,b.touches[0].pageY);p.subVectors(n,q);a.pan(p.x,p.y);q.copy(n);a.update();break;default:e=d.NONE}}},!1);window.addEventListener("keydown",function(b){if(!1!==a.enabled&&!0!==a.noKeys&&!0!==a.noPan)switch(b.keyCode){case a.keys.UP:a.pan(0,a.keyPanSpeed);a.update();break;case a.keys.BOTTOM:a.pan(0,-a.keyPanSpeed);a.update();break;case a.keys.LEFT:a.pan(a.keyPanSpeed,0);a.update();break;case a.keys.RIGHT:a.pan(-a.keyPanSpeed,0),a.update()}},!1);this.update()};FEIKI.OrbitControls.prototype=Object.create(FEIKI.EventDispatcher.prototype);